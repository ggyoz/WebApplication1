@model IEnumerable<CSR.Models.Menu>

@{
    ViewData["Title"] = "메뉴 관리";
}

<partial name="_PageTitlePartial" />

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger" role="alert">
        @TempData["Error"]
    </div>
}

<div class="d-flex">
    @* Left Section (30%) *@
    <div style="flex-basis: 30%; flex-grow: 0; flex-shrink: 0; margin-right: 1.5rem; padding:4px;"> @* Using flex-basis for ratio, margin-right for spacing *@
        <div class="d-flex justify-content-between mb-3 align-items-center">
            <div>
                
            </div>
            <div>
                <a asp-action="Create" class="btn btn-add">새 메뉴 추가</a>
            </div>
        </div>

        @if (Model != null && Model.Any())
        {
            <div class="table-responsive">
                <table class="board-tabl">
                    <colgroup>
                        <col width="40%"/>
                        <col width="60%"/>                        
                    </colgroup>

                    <thead class="table-light">
                        <tr>
                            <th>이름</th>
                            <th>링크</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var menu in Model)
                        {
                            @await Html.PartialAsync("_MenuRow", menu)
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p class="text-muted">메뉴가 없습니다.</p>
        }
    </div>

    <div class="vertical-line"></div>

    @* Right Section (70%) *@
    <div id="menuEditFormContainer" style="flex-basis: 60%; flex-grow: 1; flex-shrink: 0; padding:1.5rem; margin-right:1rem;">
        <p>왼쪽 메뉴를 선택하여 수정하세요.</p>
    </div>
</div>

@section Scripts {
    <script>
        const menuEditFormContainer = document.getElementById('menuEditFormContainer');        

        var depth1Menus = document.querySelectorAll('[data-level]:not([data-level="1"])');
        depth1Menus.forEach( menu => menu.style.display = 'none' );

        function toggleChildren(othis, menuId) {
            let icontag = othis.firstElementChild.classList;
            if(icontag.contains("show")){
                othis.firstElementChild.classList.remove("show");
            } else {
                othis.firstElementChild.classList.add("show");
            }

            var children = document.querySelectorAll(`[data-parent-id="${menuId}"]`);
            children.forEach( (child) => {
                var grandchildren = child.querySelectorAll(`[data-parent-id]`);
                grandchildren.forEach(gc => {
                    var gcIcon = gc.querySelector('.dept1-btn');
                    if(gcIcon) {
                        gcIcon.firstElementChild.classList.remove("show");
                    }
                    gc.style.display = 'none';
                });
                child.style.display = child.style.display === 'none' ? '' : 'none';
            });
        }

        function editMenu(menuId) {
            document.querySelectorAll('.board-tabl tbody tr').forEach(tr => {
                tr.classList.remove('selected');
            });

            event.currentTarget.closest('tr').classList.add('selected');

            fetch(`/Menu/GetMenuDetails/${menuId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(html => {
                    menuEditFormContainer.innerHTML = html;
                    
                    // The script from the partial view needs to be executed
                    var newScript = document.createElement('script');
                    var scriptContent = document.getElementById('menuEditFormScript').text;
                    newScript.text = scriptContent;
                    document.body.appendChild(newScript).parentNode.removeChild(newScript);
                })
                .catch(error => {
                    console.error('Error loading menu details:', error);
                    menuEditFormContainer.innerHTML = '<p class="text-danger">메뉴 정보를 불러오는데 실패했습니다.</p>';
                });
        }

        menuEditFormContainer.addEventListener('submit', function(event) {
            if (event.target && event.target.id === 'menuEditForm') {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('메뉴가 성공적으로 업데이트되었습니다.', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000); // Reload after 2 seconds to see the changes
                    } else {
                        showToast('메뉴 업데이트에 실패했습니다: ' + data.errors.join("\\n"), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error updating menu:', error);
                    showToast('메뉴 업데이트 중 오류가 발생했습니다.', 'error');
                });
            }
        });
    </script>
}

<style>
    .board-tabl tbody tr.selected {
        background-color: #e9ecef; /* 선택된 행 배경색 */
    }
    .board-tabl tbody tr:hover {
        cursor: pointer;
        background-color: #f8f9fa; /* 마우스 오버시 배경색 */
    }
</style>

